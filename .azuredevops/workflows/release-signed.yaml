trigger:
- master

strategy:
  matrix:
    platform-x86:
      arch: 'x86'
    platform-x64:
      arch: 'x64'

pool:
  vmImage: 'windows-latest'

variables:
  configuration: 'Release'
  runtime: 'win-$(arch)'
  msi: $(Build.ArtifactStagingDirectory)\$(arch)-en-us.msi

steps:
- task: UseDotNet@2
  displayName: 'Use .NET SDK'
  inputs:
    packageType: sdk
    version: 5.0.x

- script: dotnet publish $(Build.SourcesDirectory)\src\Sqlbi.Bravo\Sqlbi.Bravo.csproj --configuration $(configuration) --runtime $(runtime) --self-contained true --output $(Build.BinariesDirectory) --verbosity Minimal --force --nologo
  displayName: '.NET Publish'

- task: DotNetCoreCLI@2
  inputs:
    command: 'custom'
    custom: 'tool'
    arguments: 'update --global azuresigntool'
  displayName: 'Install AzureSignTool'

#- script: AzureSignTool sign -kvu "$(SigningVaultURL)" -kvi "$(SigningClientId)" -kvs "$(SigningClientSecret)" -kvc "$(SigningCertName)" -tr http://timestamp.digicert.com -v "$(Build.BinariesDirectory)\Bravo.exe"
#  displayName: 'Code Signing EXE'

- script: |
    CD $(Build.SourcesDirectory)\installer\
    .\wix\311\heat.exe dir "$(Build.BinariesDirectory)" -gg -scom -srd -sreg -sfrag -templatefragment -cg ComponentsAutogenerated -dr INSTALLFOLDER -var var.PublishFolder -t Transform.xslt -out Components.wxs -nologo
    .\wix\311\candle.exe Components.wxs -dPublishFolder="$(Build.BinariesDirectory)" -arch "$(arch)" -nologo
    .\wix\311\candle.exe Product.wxs -arch "$(arch)" -dPublishFolder="$(Build.BinariesDirectory)" -nologo
    .\wix\311\light.exe Product.wixobj Components.wixobj -ext WixUIExtension.dll -ext WixUtilExtension.dll -cultures:en-us -loc Product_en-us.wxl -out "$(Build.ArtifactStagingDirectory)\Bravo-$(arch)-en-us.msi" -sice:ICE61 -sice:ICE80 -nologo
  displayName: 'Build MSI'

#- script: AzureSignTool sign -kvu "$(SigningVaultURL)" -kvi "$(SigningClientId)" -kvs "$(SigningClientSecret)" -kvc "$(SigningCertName)" -tr http://timestamp.digicert.com -v "$(Build.ArtifactStagingDirectory)\Bravo-$(arch)-en-us.msi"
#  displayName: 'Code Signing MSI'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifacts'
  inputs:
    pathToPublish: $(Build.ArtifactStagingDirectory)
    artifactName: 'drop-$(arch)'