#trigger:
#- master

strategy:
  matrix:
    platform-x64:
      arch: 'x64'
#    platform-x86:
#      arch: 'x86'

pool:
  vmImage: 'windows-latest'

variables:
  configuration: 'Release'
  runtime: 'win-$(arch)'
  msi: $(Build.ArtifactStagingDirectory)\$(arch)-en-us.msi

steps:
- script: dotnet publish $(Build.SourcesDirectory)\src\Bravo.csproj --configuration $(configuration) --runtime $(runtime) --self-contained true --output $(Build.BinariesDirectory) --verbosity Normal --force --nologo
  displayName: '.NET Publish'

- task: DotNetCoreCLI@2
  inputs:
    command: 'custom'
    custom: 'tool'
    arguments: 'update --global azuresigntool'
  displayName: 'Install AzureSignTool'

- script: AzureSignTool sign -kvu "$(SigningVaultURL)" -kvi "$(SigningClientId)" -kvs "$(SigningClientSecret)" -kvc "$(SigningCertName)" -tr http://timestamp.digicert.com -v "$(Build.BinariesDirectory)\Bravo.exe"
  displayName: 'Code Signing EXE'

- script: |
    CD $(Build.SourcesDirectory)\installer\wix
    .\bin\heat.exe dir "$(Build.BinariesDirectory)" -gg -scom -srd -sreg -sfrag -templatefragment -cg ComponentsAutogenerated -dr INSTALLFOLDER -var var.PublishFolder -t Bravo.xslt -out Components.wxs -nologo
    .\bin\candle.exe Components.wxs -dPublishFolder="$(Build.BinariesDirectory)" -arch "$(arch)" -nologo
    .\bin\candle.exe Bravo.wxs -arch "$(arch)" -dPublishFolder="$(Build.BinariesDirectory)" -nologo
    .\bin\light.exe Bravo.wixobj Components.wixobj -ext WixUIExtension.dll -ext WixUtilExtension.dll -cultures:en-us -loc Bravo-en-us.wxl -out "$(Build.ArtifactStagingDirectory)\Bravo-$(arch)-en-us.msi" -sice:ICE61 -sice:ICE80 -nologo
  displayName: 'Build MSI'

- script: AzureSignTool sign -kvu "$(SigningVaultURL)" -kvi "$(SigningClientId)" -kvs "$(SigningClientSecret)" -kvc "$(SigningCertName)" -tr http://timestamp.digicert.com -v "$(Build.ArtifactStagingDirectory)\Bravo-$(arch)-en-us.msi"
  displayName: 'Code Signing MSI'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifacts'
  inputs:
    pathToPublish: $(Build.ArtifactStagingDirectory)
    artifactName: 'drop-$(arch)'